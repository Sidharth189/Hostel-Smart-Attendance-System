{% extends 'base.html' %}
{% block title %}Attendance Records - HostelAttend{% endblock %}
{% block page_title %}Attendance Records{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card-glass mb-4">
    <div class="card-glass-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="filter-date" value="{{ '' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="filter-department">
                    <option value="">All Departments</option>
                    {% for d in departments %}
                    <option value="{{ d.id }}">{{ d.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Student</label>
                <select class="form-select" id="filter-student">
                    <option value="">All Students</option>
                    {% for s in students %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="loadRecords()">
                    <i class="bi bi-funnel-fill me-2"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manual Mark -->
<div class="card-glass mb-4" id="manual-panel" style="display:none">
    <div class="card-glass-header">
        <h6 class="mb-0 fw-600"><i class="bi bi-pencil-square me-2 text-warning"></i>Mark Attendance Manually</h6>
        <button class="btn btn-xs btn-outline-secondary"
            onclick="document.getElementById('manual-panel').style.display='none'">✕</button>
    </div>
    <div class="card-glass-body">
        <div class="row g-3">
            <div class="col-md-3">
                <select class="form-select" id="manual-student" onchange="onStudentChange()">
                    <option value="">Select Student</option>
                    {% for s in students %}
                    <option value="{{ s.id }}" data-dept="{{ s.department or '' }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="manual-department" onchange="onDeptChange()">
                    <option value="">Select Department</option>
                    {% for d in departments %}
                    <option value="{{ d.id }}" data-name="{{ d.name }}">{{ d.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" id="manual-date">
            </div>
            <div class="col-md-2">
                <select class="form-select" id="manual-status">
                    <option value="present">Present</option>
                    <option value="late">Late</option>
                    <option value="absent">Absent</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-warning w-100 text-dark" onclick="manualMark()">
                    <i class="bi bi-check-lg me-1"></i>Mark
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Table -->
<div class="card-glass">
    <div class="card-glass-header">
        <h6 class="mb-0 fw-600"><i class="bi bi-table me-2 text-info"></i>Records <span class="text-muted small"
                id="record-count"></span></h6>
        <button class="btn btn-xs btn-outline-warning"
            onclick="document.getElementById('manual-panel').style.display='block'">
            <i class="bi bi-pencil-square me-1"></i>Manual Mark
        </button>
    </div>
    <div class="card-glass-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0" id="records-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Roll No</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Confidence</th>
                        <th>Marked By</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="records-body">
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">Loading records…</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Set today as default date
    document.getElementById('filter-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('manual-date').value = new Date().toISOString().split('T')[0];

    // ── Bidirectional dept ↔ student filtering in manual mark ────────────
    const allStudentOptions = Array.from(
        document.getElementById('manual-student').options
    ).filter(o => o.value !== '');  // skip the placeholder

    function onDeptChange() {
        const deptSel = document.getElementById('manual-department');
        const selectedDeptName = deptSel.options[deptSel.selectedIndex]?.dataset.name || '';
        const studentSel = document.getElementById('manual-student');

        // Reset student dropdown
        studentSel.innerHTML = '<option value="">Select Student</option>';
        allStudentOptions.forEach(opt => {
            if (!selectedDeptName || opt.dataset.dept === selectedDeptName) {
                studentSel.appendChild(opt.cloneNode(true));
            }
        });
        studentSel.value = '';
    }

    function onStudentChange() {
        const studentSel = document.getElementById('manual-student');
        const selectedOpt = studentSel.options[studentSel.selectedIndex];
        const studentDept = selectedOpt?.dataset.dept || '';
        if (!studentDept) return;

        // Auto-select matching department
        const deptSel = document.getElementById('manual-department');
        Array.from(deptSel.options).forEach(opt => {
            if (opt.dataset.name === studentDept) deptSel.value = opt.value;
        });
    }

    function loadRecords() {
        const date = document.getElementById('filter-date').value;
        const department = document.getElementById('filter-department').value;
        const student = document.getElementById('filter-student').value;

        let url = '/attendance/api/records?per_page=100';
        if (date) url += `&date=${date}`;
        if (department) url += `&department_id=${department}`;
        if (student) url += `&student_id=${student}`;

        fetch(url)
            .then(r => r.json())
            .then(data => {
                document.getElementById('record-count').textContent = `(${data.total})`;
                const tbody = document.getElementById('records-body');
                if (data.records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="bi bi-inbox fs-4 d-block mb-2"></i>No records found</td></tr>';
                    return;
                }
                tbody.innerHTML = data.records.map(r => `
            <tr>
                <td><strong>${r.student_name || '—'}</strong></td>
                <td><code>${r.student_roll || ''}</code></td>
                <td>${r.department_name || '<span class="text-muted">—</span>'}</td>
                <td>${r.date}</td>
                <td>${r.time_in || '—'}</td>
                <td><span class="badge-status badge-${r.status}">${r.status}</span></td>
                <td>${r.confidence !== null ? r.confidence + '%' : '—'}</td>
                <td><span class="badge bg-secondary">${r.marked_by}</span></td>
                <td>
                    <button class="btn btn-xs btn-outline-danger" onclick="deleteRecord(${r.id})">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            </tr>
        `).join('');
            });
    }

    function deleteRecord(id) {
        if (!confirm('Delete this attendance record?')) return;
        fetch(`/attendance/api/delete/${id}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) { showToast('Record deleted', 'success'); loadRecords(); }
            });
    }

    function manualMark() {
        const student_id = document.getElementById('manual-student').value;
        const department_id = document.getElementById('manual-department').value;
        const date = document.getElementById('manual-date').value;
        const status = document.getElementById('manual-status').value;

        if (!student_id) { showToast('Select a student', 'warning'); return; }

        fetch('/attendance/api/manual', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: parseInt(student_id), department_id: department_id ? parseInt(department_id) : null, date, status })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) { showToast(data.message, 'success'); loadRecords(); }
                else showToast(data.error || 'Failed to mark', 'danger');
            });
    }

    loadRecords();
</script>
{% endblock %}