{% extends 'base.html' %}
{% block title %}Edit Student - FaceAttend{% endblock %}
{% block page_title %}Edit Student{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-7 col-lg-9">
        <div class="card-glass">
            <div class="card-glass-header">
                <h6 class="mb-0 fw-600"><i class="bi bi-pencil-fill me-2 text-warning"></i>Edit Student</h6>
                <a href="{{ url_for('students.list_students') }}" class="btn btn-xs btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </a>
            </div>
            <div class="card-glass-body">
                <form id="edit-form" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Student ID</label>
                            <input type="text" class="form-control" value="{{ student.student_id }}" disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" value="{{ student.name }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="{{ student.email or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department" style="color:#000; background-color:#fff;">
                                <option value="">-- Select Department --</option>
                                {% for d in departments %}
                                <option value="{{ d.name }}" {% if student.department==d.name %}selected{% endif %}>{{
                                    d.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Year</label>
                            <select class="form-select" name="year" style="color:#000; background-color:#fff;">
                                <option value="">-</option>
                                {% set labels = {1:'1st Year', 2:'2nd Year', 3:'3rd Year', 4:'4th Year'} %}
                                {% for y in [1,2,3,4] %}
                                <option value="{{ y }}" {% if student.year==y %}selected{% endif %}>{{ labels[y] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Update Photo <small class="text-muted">(leave blank to keep
                                    current)</small></label>
                            <div class="photo-upload-area" id="upload-area"
                                onclick="document.getElementById('photo-input').click()">
                                {% if student.photo_path %}
                                <img id="photo-preview" class="photo-preview"
                                    src="{{ url_for('static', filename=student.photo_path) }}">
                                <div id="upload-placeholder" style="display:none">
                                    {% else %}
                                    <img id="photo-preview" class="photo-preview" style="display:none">
                                    <div id="upload-placeholder">
                                        {% endif %}
                                        <i class="bi bi-camera-fill fs-2 mb-2"></i>
                                        <p class="mb-1">Click to update photo</p>
                                        <small class="text-muted">A clear frontal face photo</small>
                                    </div>
                                </div>
                                <input type="file" id="photo-input" name="photo" accept="image/*" class="d-none"
                                    onchange="previewPhoto(this)">
                                {% if student.encoding_path %}
                                <small class="text-success mt-1 d-block"><i
                                        class="bi bi-shield-fill-check me-1"></i>Face data registered</small>
                                {% else %}
                                <small class="text-warning mt-1 d-block"><i class="bi bi-shield-exclamation me-1"></i>No
                                    face data — upload a photo to enable recognition</small>
                                {% endif %}
                            </div>
                        </div>

                        <div id="form-feedback" class="mt-3" style="display:none"></div>

                        <div class="d-flex gap-3 mt-4">
                            <button type="submit" class="btn btn-warning text-dark" id="submit-btn">
                                <i class="bi bi-check-lg me-2"></i>Save Changes
                            </button>
                            <a href="{{ url_for('students.list_students') }}"
                                class="btn btn-outline-secondary">Cancel</a>
                        </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function previewPhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('photo-preview').src = e.target.result;
                document.getElementById('photo-preview').style.display = 'block';
                document.getElementById('upload-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.getElementById('edit-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving…';
        const formData = new FormData(this);
        fetch('/students/{{ student.id }}/edit', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                const fb = document.getElementById('form-feedback');
                fb.style.display = 'block';
                if (data.success) {
                    fb.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>${data.message}</div>`;
                    showToast(data.message, 'success');
                    setTimeout(() => window.location = '/students/', 1500);
                } else {
                    fb.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Save Changes';
                }
            });
    });
</script>
{% endblock %}