{% extends 'base.html' %}
{% block title %}Students - FaceAttend{% endblock %}
{% block page_title %}Student Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h5 class="mb-1 fw-700">All Students</h5>
        <small class="text-muted">{{ students|length }} registered students</small>
    </div>
    <a href="{{ url_for('students.add_student') }}" class="btn btn-primary">
        <i class="bi bi-person-plus-fill me-2"></i>Add Student
    </a>
</div>

<!-- Search -->
<div class="card-glass mb-4">
    <div class="card-glass-body">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" class="form-control" id="search-input" placeholder="ðŸ” Search by name or IDâ€¦"
                    oninput="filterStudents()">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="dept-filter" onchange="filterStudents()">
                    <option value="">All Departments</option>
                    {% set depts = students | map(attribute='department') | select('string') | unique | list %}
                    {% for d in depts %}
                    <option value="{{ d }}">{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>

{% if students %}
<div class="row g-4" id="student-grid">
    {% for s in students %}
    <div class="col-xl-3 col-lg-4 col-md-6 student-card-col" data-name="{{ s.name.lower() }}"
        data-id="{{ s.student_id.lower() }}" data-dept="{{ (s.department or '').lower() }}">
        <div class="student-card">
            <div class="student-card-photo">
                {% if s.photo_path %}
                <img src="{{ url_for('static', filename=s.photo_path) }}" alt="{{ s.name }}">
                {% else %}
                <div class="photo-placeholder"><i class="bi bi-person-fill"></i></div>
                {% endif %}
                <div class="face-badge {% if s.encoding_path %}face-ok{% else %}face-missing{% endif %}"
                    title="{{ 'Face data registered' if s.encoding_path else 'No face data' }}">
                    <i
                        class="bi bi-{% if s.encoding_path %}shield-fill-check{% else %}shield-exclamation{% endif %}"></i>
                </div>
            </div>
            <div class="student-card-body">
                <h6 class="student-name">{{ s.name }}</h6>
                <div class="student-id">{{ s.student_id }}</div>
                <div class="student-meta">
                    {% if s.department %}<span class="badge-dept">{{ s.department }}</span>{% endif %}
                    {% if s.year %}<span class="text-muted small">Year {{ s.year }}</span>{% endif %}
                </div>
            </div>
            <div class="student-card-footer">
                <a href="{{ url_for('students.edit_student', student_id=s.id) }}"
                    class="btn btn-xs btn-outline-primary">
                    <i class="bi bi-pencil-fill"></i>
                </a>
                <button class="btn btn-xs btn-outline-danger" onclick="deleteStudent({{ s.id }}, '{{ s.name }}')">
                    <i class="bi bi-trash-fill"></i>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state card-glass">
    <i class="bi bi-people"></i>
    <h5>No Students Yet</h5>
    <p class="text-muted">Add your first student to get started</p>
    <a href="{{ url_for('students.add_student') }}" class="btn btn-primary">
        <i class="bi bi-person-plus-fill me-2"></i>Add Student
    </a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function filterStudents() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const dept = document.getElementById('dept-filter').value.toLowerCase();
        document.querySelectorAll('.student-card-col').forEach(col => {
            const nameMatch = col.dataset.name.includes(q) || col.dataset.id.includes(q);
            const deptMatch = !dept || col.dataset.dept === dept;
            col.style.display = (nameMatch && deptMatch) ? '' : 'none';
        });
    }

    function deleteStudent(id, name) {
        if (!confirm(`Delete student "${name}"? This will also remove their attendance records.`)) return;
        fetch(`/students/${id}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || 'Failed to delete', 'danger');
                }
            });
    }
</script>
{% endblock %}