{% extends 'base.html' %}
{% block title %}Add Student - FaceAttend{% endblock %}
{% block page_title %}Add New Student{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-7 col-lg-9">
        <div class="card-glass">
            <div class="card-glass-header">
                <h6 class="mb-0 fw-600"><i class="bi bi-person-plus-fill me-2 text-primary"></i>Student Registration
                </h6>
                <a href="{{ url_for('students.list_students') }}" class="btn btn-xs btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </a>
            </div>
            <div class="card-glass-body">
                <form id="add-form" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Student ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="student_id" required
                                placeholder="e.g. CS2024001">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" required placeholder="Full name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" placeholder="student@email.com">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department" style="color:#000; background-color:#fff;">
                                <option value="">-- Select Department --</option>
                                {% for d in departments %}
                                <option value="{{ d.name }}">{{ d.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Year</label>
                            <select class="form-select" name="year" style="color:#000; background-color:#fff;">
                                <option value="">-</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Student Photo <small class="text-muted">(for face
                                    recognition)</small></label>
                            <div class="photo-upload-area" id="upload-area"
                                onclick="document.getElementById('photo-input').click()">
                                <div class="photo-upload-placeholder" id="upload-placeholder">
                                    <i class="bi bi-camera-fill fs-2 mb-2"></i>
                                    <p class="mb-1">Click or drag to upload photo</p>
                                    <small class="text-muted">JPG, PNG — Clear frontal face photo recommended</small>
                                </div>
                                <img id="photo-preview" class="photo-preview" style="display:none">
                            </div>
                            <input type="file" id="photo-input" name="photo" accept="image/*" class="d-none"
                                onchange="previewPhoto(this)">
                        </div>
                    </div>

                    <div id="form-feedback" class="mt-3" style="display:none"></div>

                    <div class="d-flex gap-3 mt-4">
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <i class="bi bi-person-check-fill me-2"></i>Register Student
                        </button>
                        <a href="{{ url_for('students.list_students') }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function previewPhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('photo-preview').src = e.target.result;
                document.getElementById('photo-preview').style.display = 'block';
                document.getElementById('upload-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Drag & drop
    const area = document.getElementById('upload-area');
    area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
    area.addEventListener('dragleave', () => area.classList.remove('dragover'));
    area.addEventListener('drop', e => {
        e.preventDefault();
        area.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) {
            document.getElementById('photo-input').files = files;
            previewPhoto(document.getElementById('photo-input'));
        }
    });

    document.getElementById('add-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing…';

        const formData = new FormData(this);
        fetch('/students/add', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                const fb = document.getElementById('form-feedback');
                fb.style.display = 'block';
                if (data.success) {
                    fb.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>${data.message}</div>`;
                    showToast(data.message, 'success');
                    setTimeout(() => window.location = '/students/', 1500);
                } else {
                    fb.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>${data.error}</div>`;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-person-check-fill me-2"></i>Register Student';
                }
            })
            .catch(() => {
                showToast('Network error', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-person-check-fill me-2"></i>Register Student';
            });
    });
</script>
{% endblock %}